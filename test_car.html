<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Финальная сцена — кнопки перезапуска</title>
    <style>
        body { margin:0; overflow:hidden; background:#000; }
        #scene { width:100vw; height:100vh; position:relative; background:url('media/main.png') no-repeat center 60%/75%; perspective:800px; }

        /* Машины */
        #car1 { position:absolute; width:160px; top:27%; left:-220px; animation: drive-horizontal 20s linear infinite; z-index:10; }
        #car1 .car-body { width:100%; position:relative; bottom:10px; }
        #car1 .wheel { position:absolute; width:18%; animation:rotate 0.5s linear infinite; }
        #front-wheel-1 { bottom:5%; right:10%; }
        #back-wheel-1 { bottom:5%; left:11%; }
        @keyframes drive-horizontal { from { transform: translateX(120vw); } to { transform: translateX(-120vw); } }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }

        .vertical-car { position:absolute; width:200px; z-index:5; }
        .vertical-car img { width:100%; height:auto; }
        #car2 { animation: drive-closer 12s linear infinite; }
        @keyframes drive-closer { from { transform: translate(44vw,-7vh) scale(0.12); } to { transform: translate(54vw,85vh) scale(1.2); } }
        #car3 { animation: drive-away 12s linear infinite; }
        @keyframes drive-away { from { transform: translate(23vw,85vh) scale(1.2); } to { transform: translate(43vw,1vh) scale(0.12); } }

        /* Скелет */
        .skeleton { position:absolute; transform-origin:top center; transform-style:preserve-3d; animation:fall-closer 80s linear infinite; z-index:1; }
        @keyframes fall-closer { from { transform: translate(43vw,-20vh) scale(0.01); } to { transform: translate(90vw,110vh) scale(0.1); } }
        .head { position:absolute; top:100px; left:270px; width:327px; height:496px; background:url('media/golova.png') no-repeat center/contain; z-index:10; }
        .torso { position:absolute; top:400px; left:60px; width:737px; height:837px; background:url('media/telo.png') no-repeat center/contain; transform-origin:top center; z-index:5; }
        .arm { position:absolute; }
        .arm.left { top:600px; left:600px; }
        .arm.right { top:600px; left:45px; }
        .upper-arm.left, .upper-arm.right { position:relative; transform-origin:top center; background-size:contain; background-repeat:no-repeat; }
        .upper-arm.left { width:205px; height:444px; background-image:url('media/levruka1.png'); }
        .upper-arm.right { width:204px; height:458px; background-image:url('media/pravruka1.png'); }
        .forearm.left, .forearm.right { position:absolute; transform-origin:top center; background-size:contain; background-repeat:no-repeat; z-index:20; }
        .forearm.left { top:344px; left:0; width:164px; height:382px; background-image:url('media/levruka2.png'); }
        .forearm.right { top:318px; left:0; width:163px; height:386px; background-image:url('media/pravruka2.png'); }
        .hand.left, .hand.right { position:absolute; transform-origin:top center; background-size:contain; background-repeat:no-repeat; }
        .hand.left { top:360px; left:50px; width:108px; height:194px; background-image:url('media/levruka3.png'); }
        .hand.right { top:350px; left:0; width:108px; height:194px; background-image:url('media/pravruka3.png'); }
        .legs-container { position:absolute; top:1130px; left:210px; width:433px; height:752px; }
        .legs-container img { width:100%; height:auto; display:block; }

        /* кнопки */
        #scenarios-controls { position:absolute; right:14px; top:14px; z-index:9999; display:flex; gap:8px; background:rgba(0,0,0,0.45); padding:8px; border-radius:6px; pointer-events:auto; }
        #scenarios-controls button { background:#fff1; border:1px solid rgba(255,255,255,0.06); color:#fff; padding:8px 10px; border-radius:4px; cursor:pointer; font-weight:600; }
        #scenarios-controls button:active { transform:translateY(1px); }
        #paused { animation-play-state:paused !important; }
    </style>
</head>
<body>
<div id="scene">
    <div id="car1">
        <img class="car-body" src="media/car_yogurt_2.png" alt="Машина 1">
        <img class="wheel" id="front-wheel-1" src="media/koleso.png" alt="Колесо">
        <img class="wheel" id="back-wheel-1" src="media/koleso.png" alt="Колесо">
    </div>
    <div id="car2" class="vertical-car">
        <img src="media/car_yogurt_1.png" alt="Машина 2 (спереди)">
    </div>
    <div id="car3" class="vertical-car">
        <img src="media/car_yogurt_3.png" alt="Машина 3 (сзади)">
    </div>

    <div class="skeleton">
        <div class="head"></div>
        <div class="torso"></div>
        <div class="arm left">
            <div class="upper-arm left">
                <div class="forearm left">
                    <div class="hand left"></div>
                </div>
            </div>
        </div>
        <div class="arm right">
            <div class="upper-arm right">
                <div class="forearm right">
                    <div class="hand right"></div>
                </div>
            </div>
        </div>
        <div class="legs-container">
            <img id="legs" src="media/nogi1.png" alt="legs">
        </div>
    </div>

    <div id="scenarios-controls">
        <button id="btn-gesture-1">Жест 1</button>
        <button id="btn-gesture-2">Жест 2</button>
        <button id="btn-gesture-3">Жест 3</button>
        <button id="btn-gesture-4">Жест 4</button>
    </div>
</div>

<script>
    const leftUpper = document.querySelector('.upper-arm.left');
    const rightUpper = document.querySelector('.upper-arm.right');
    const head = document.querySelector('.head');
    const legs = document.getElementById('legs');

    const legFrames = ['media/nogi1.png','media/nogi2.png','media/nogi3.png'];
    let legFrame=0, step=0, armTime=0;
    const lerp = (a,b,t)=>a+(b-a)*t;
    let lastTime=0;

    function animateSkeleton(time){
        const delta=(time-lastTime)/1000||0;
        lastTime=time;
        step+=delta*2;
        armTime+=delta*3;
        leftUpper.style.transform=`scale(${1+Math.sin(armTime)*0.03})`;
        rightUpper.style.transform=`scale(${1+Math.sin(armTime+Math.PI)*0.03})`;
        head.style.transform=`translate(${Math.sin(step)*3}px,${Math.cos(step*2)*2}px) rotate(${Math.sin(step)*2}deg)`;
        if(step%1.5<delta*2){ legs.src=legFrames[legFrame]; legFrame=(legFrame+1)%legFrames.length; }
        requestAnimationFrame(animateSkeleton);
    }
    requestAnimationFrame(animateSkeleton);

    const cars=[document.getElementById('car1'),document.getElementById('car2'),document.getElementById('car3')];
    cars.forEach(c=>c._origAnimation=getComputedStyle(c).animation||'');

    function restartCSSAnimation(el){
        if(!el)return;
        el.style.animation='none';
        void el.offsetWidth;
        el.style.animation=el._origAnimation||'';
        el.style.animationPlayState='running';
    }

    function restartAll(){
        cars.forEach(c=>{ if(c)restartCSSAnimation(c); });
        legFrame=0; step=0; armTime=0; lastTime=0;
        if(legs)legs.src=legFrames[0];
    }

    const scenarios=[
        {states:{car1:'go',car2:'stop',car3:'stop'}},
        {states:{car1:'stop',car2:'go',car3:'stop'}},
        {states:{car1:'stop',car2:'stop',car3:'go'}},
        {states:{car1:'go',car2:'go',car3:'stop'}}
    ];

    function applyScenario(i){
        restartAll();
        setTimeout(()=>{
            const mapping=[{id:'car1',el:document.getElementById('car1')},{id:'car2',el:document.getElementById('car2')},{id:'car3',el:document.getElementById('car3')}];
            mapping.forEach(m=>{
                const desired=scenarios[i].states[m.id];
                if(!m.el)return;
                if(desired==='go'){ m.el.style.animationPlayState='running'; m.el.classList.remove('paused'); }
                else{ m.el.style.animationPlayState='paused'; m.el.classList.add('paused'); }
            });
        },30);
    }

    document.getElementById('btn-gesture-1').addEventListener('click',()=>applyScenario(0));
    document.getElementById('btn-gesture-2').addEventListener('click',()=>applyScenario(1));
    document.getElementById('btn-gesture-3').addEventListener('click',()=>applyScenario(2));
    document.getElementById('btn-gesture-4').addEventListener('click',()=>applyScenario(3));
</script>
</body>
</html>
